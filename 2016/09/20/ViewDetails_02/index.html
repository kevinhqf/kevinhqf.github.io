<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Android学习笔记---深入理解View#02 | Kevin&#39;s GHB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="上篇文章中我们了解到了setContentView()背后所发生的事情.先用上一篇文章最后总结的图片来回顾一下setContentView()的流程.但是后来我发现,我们只是知道了mDecor是怎样与mContentParent联系在一起并将我们的activity_main.xml布局添加到其中.而并不知道mDecor是如何添加到PhoneWindow和Activity上的.所以本篇我们就来探究一">
<meta property="og:type" content="article">
<meta property="og:title" content="Android学习笔记---深入理解View#02">
<meta property="og:url" content="http://kevinhqf.github.io/2016/09/20/ViewDetails_02/index.html">
<meta property="og:site_name" content="Kevin's GHB">
<meta property="og:description" content="上篇文章中我们了解到了setContentView()背后所发生的事情.先用上一篇文章最后总结的图片来回顾一下setContentView()的流程.但是后来我发现,我们只是知道了mDecor是怎样与mContentParent联系在一起并将我们的activity_main.xml布局添加到其中.而并不知道mDecor是如何添加到PhoneWindow和Activity上的.所以本篇我们就来探究一">
<meta property="og:image" content="http://o7x6n1hmo.bkt.clouddn.com/image/setContentView.png">
<meta property="og:image" content="http://o7x6n1hmo.bkt.clouddn.com/image/debug.png">
<meta property="og:image" content="http://o7x6n1hmo.bkt.clouddn.com/image/schdule.png">
<meta property="og:updated_time" content="2016-09-20T02:53:43.625Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android学习笔记---深入理解View#02">
<meta name="twitter:description" content="上篇文章中我们了解到了setContentView()背后所发生的事情.先用上一篇文章最后总结的图片来回顾一下setContentView()的流程.但是后来我发现,我们只是知道了mDecor是怎样与mContentParent联系在一起并将我们的activity_main.xml布局添加到其中.而并不知道mDecor是如何添加到PhoneWindow和Activity上的.所以本篇我们就来探究一">
<meta name="twitter:image" content="http://o7x6n1hmo.bkt.clouddn.com/image/setContentView.png">
  
    <link rel="alternate" href="/atom.xml" title="Kevin&#39;s GHB" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
  
  
    <link href="//fonts.useso.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Kevin&#39;s GHB</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Use your way to change your life</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-github-link" class="nav-icon" href="https://github.com/kevinhqf" title="Github" target="_blank"></a>
        
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed" target="_blank"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://kevinhqf.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-ViewDetails_02" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
<a href="/2016/09/20/ViewDetails_02/" class="article-date">
  <time datetime="2016-09-20T02:53:43.625Z" itemprop="datePublished">2016-09-20</time>
</a>


    
  <div class="article-category">
    <a class="article-category-link" href="/categories/android/">Android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Android学习笔记---深入理解View#02
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
		
        <p><a href="http://www.jianshu.com/p/c05463402a49" target="_blank" rel="external">上篇文章</a>中我们了解到了<code>setContentView()</code>背后所发生的事情.先用上一篇文章最后总结的图片来回顾一下<code>setContentView()</code>的流程.<br><img src="http://o7x6n1hmo.bkt.clouddn.com/image/setContentView.png" alt=""><br>但是后来我发现,我们只是知道了<code>mDecor</code>是怎样与<code>mContentParent</code>联系在一起并将我们的<code>activity_main.xml</code>布局添加到其中.<strong>而并不知道<code>mDecor</code>是如何添加到<code>PhoneWindow</code>和<code>Activity</code>上的.</strong>所以本篇我们就来探究一下这个问题.</p>
<h3 id="寻找我们的-mDecor"><a href="#寻找我们的-mDecor" class="headerlink" title="寻找我们的 mDecor"></a>寻找我们的 <em>mDecor</em></h3><p>既然我们在<code>PhoneWindow</code>里没有发现<code>mDecor</code>是如何添加到window上的.那么我就需要到别的地方去寻找<code>mDecor</code>的线索,那我们要该从哪入手呢?还记得上一篇我们从Activity的<code>setContentView()</code>出发时,最终调用的是<code>mWindow(PhoneWindow)</code>的<code>setContentView()</code>函数,而<code>mDecor</code>是<code>PhoneWindow</code>的成员变量,<code>mWindow</code>是<code>Activity</code>的成员变量,那么我们可以在<code>Activity</code>的代码中寻找一下我们的线索<code>mDecor</code>.<br>果然通过在<code>Activity</code>代码中进行<code>mDecor</code>的关键字搜索,我们找到了线索.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">View mDecor = <span class="keyword">null</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">makeVisible</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!mWindowAdded) &#123;</span><br><span class="line">            ViewManager wm = getWindowManager();</span><br><span class="line">            wm.addView(mDecor, getWindow().getAttributes());</span><br><span class="line">            mWindowAdded = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mDecor.setVisibility(View.VISIBLE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从上面的代码可以看到<code>Activity</code>通过<code>WindowManager</code>的<code>addView()</code>方法将<code>mDecor</code>添加到<code>Window</code>上.但我们发现这里的<code>mDecor</code>与<code>PhoneWindow</code>中的<code>mDecor</code>好像并不相同.而且在代码中(<code>Activity</code>代码中的<code>mDecor</code>)与(<code>PhoneWindow</code>的<code>mDecor</code>)并没有明显的联系在一起.难道线索就这么断了?我决定使用绝招(搜索引擎),果然我找到了另一个切入点.<br>经过一番Internet后,我知道了View的布局绘制是发生在Activity的创建过程,而Activity的创建是由一个名为<code>ActivityThread</code>的类进行控制的.下面我们来验证一下,看看能否找到线索.<br>首先我们找到<code>ActivityThread</code>的源码,这里有两种方法:</p>
<ol>
<li>直接在Internet上阅读<a href="https://android.googlesource.com/platform/frameworks/base/+/master/core/java/android/app/ActivityThread.java" target="_blank" rel="external">在线的源码</a></li>
<li>在Android Studio中新建一个简单的工程,在<code>MainActivity</code>的<code>onCreate()</code>函数中下一个断点,然后运行调试.我们可以在调试工具的调用栈中找到<code>ActivityThread</code>.<br><img src="http://o7x6n1hmo.bkt.clouddn.com/image/debug.png" alt=""></li>
</ol>
<p>找到了<code>ActivityThread</code>的源码后,对<code>makeVisible</code>关键字进行搜索,果然找到了调用的地方,在<code>handleResumeActivity()</code>中出现了<code>makeVisible()</code>的调用,既然出现了相关的调用,那我们就看一下<code>handleResumeActivity()</code>的代码吧.<br><a id="more"></a><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">handleResumeActivity</span><span class="params">(IBinder token,</span><br><span class="line">           <span class="keyword">boolean</span> clearHide, <span class="keyword">boolean</span> isForward, <span class="keyword">boolean</span> reallyResume)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// If we are getting ready to gc after going to the background, well</span></span><br><span class="line">       <span class="comment">// we are back active so skip it.</span></span><br><span class="line">       unscheduleGcIdler();</span><br><span class="line">       mSomeActivitiesChanged = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// TODO Push resumeArgs into the activity for consideration</span></span><br><span class="line">       ActivityClientRecord r = performResumeActivity(token, clearHide);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">final</span> Activity a = r.activity;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (localLOGV) Slog.v(</span><br><span class="line">               TAG, <span class="string">"Resume "</span> + r + <span class="string">" started activity: "</span> +</span><br><span class="line">               a.mStartedActivity + <span class="string">", hideForNow: "</span> + r.hideForNow</span><br><span class="line">               + <span class="string">", finished: "</span> + a.mFinished);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">int</span> forwardBit = isForward ?</span><br><span class="line">                   WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION : <span class="number">0</span>;</span><br><span class="line">		</span><br><span class="line">           <span class="comment">// If the window hasn't yet been added to the window manager,</span></span><br><span class="line">           <span class="comment">// and this guy didn't finish itself or start another activity,</span></span><br><span class="line">           <span class="comment">// then go ahead and add the window.</span></span><br><span class="line">           <span class="keyword">boolean</span> willBeVisible = !a.mStartedActivity;<span class="comment">// 标记1开始</span></span><br><span class="line">           <span class="keyword">if</span> (!willBeVisible) &#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   willBeVisible = ActivityManagerNative.getDefault().willActivityBeVisible(</span><br><span class="line">                           a.getActivityToken());</span><br><span class="line">               &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (r.window == <span class="keyword">null</span> &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;</span><br><span class="line">               r.window = r.activity.getWindow();</span><br><span class="line">               View decor = r.window.getDecorView();</span><br><span class="line">               decor.setVisibility(View.INVISIBLE);</span><br><span class="line">               ViewManager wm = a.getWindowManager();</span><br><span class="line">               WindowManager.LayoutParams l = r.window.getAttributes();</span><br><span class="line">               a.mDecor = decor;</span><br><span class="line">               l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION;</span><br><span class="line">               l.softInputMode |= forwardBit;</span><br><span class="line">               <span class="keyword">if</span> (a.mVisibleFromClient) &#123;</span><br><span class="line">                   a.mWindowAdded = <span class="keyword">true</span>;</span><br><span class="line">                   wm.addView(decor, l);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// If the window has already been added, but during resume</span></span><br><span class="line">           <span class="comment">// we started another activity, then don't yet make the</span></span><br><span class="line">           <span class="comment">// window visible.</span></span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!willBeVisible) &#123;</span><br><span class="line">               <span class="keyword">if</span> (localLOGV) Slog.v(</span><br><span class="line">                   TAG, <span class="string">"Launch "</span> + r + <span class="string">" mStartedActivity set"</span>);</span><br><span class="line">               r.hideForNow = <span class="keyword">true</span>;</span><br><span class="line">           &#125; <span class="comment">// 标注 1结束</span></span><br><span class="line"></span><br><span class="line">           <span class="comment">// Get rid of anything left hanging around.</span></span><br><span class="line">           cleanUpPendingRemoveWindows(r);</span><br><span class="line"></span><br><span class="line">           <span class="comment">// The window is now visible if it has been added, we are not</span></span><br><span class="line">           <span class="comment">// simply finishing, and we are not starting another activity.</span></span><br><span class="line">           <span class="comment">// 标注 2开始</span></span><br><span class="line">           <span class="keyword">if</span> (!r.activity.mFinished &amp;&amp; willBeVisible</span><br><span class="line">                   &amp;&amp; r.activity.mDecor != <span class="keyword">null</span> &amp;&amp; !r.hideForNow) &#123;</span><br><span class="line">               <span class="keyword">if</span> (r.newConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   r.tmpConfig.setTo(r.newConfig);</span><br><span class="line">                   <span class="keyword">if</span> (r.overrideConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                       r.tmpConfig.updateFrom(r.overrideConfig);</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG, <span class="string">"Resuming activity "</span></span><br><span class="line">                           + r.activityInfo.name + <span class="string">" with newConfig "</span> + r.tmpConfig);</span><br><span class="line">                   performConfigurationChanged(r.activity, r.tmpConfig);</span><br><span class="line">                   freeTextLayoutCachesIfNeeded(r.activity.mCurrentConfig.diff(r.tmpConfig));</span><br><span class="line">                   r.newConfig = <span class="keyword">null</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">"Resuming "</span> + r + <span class="string">" with isForward="</span></span><br><span class="line">                       + isForward);</span><br><span class="line">               WindowManager.LayoutParams l = r.window.getAttributes();</span><br><span class="line">               <span class="keyword">if</span> ((l.softInputMode</span><br><span class="line">                       &amp; WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION)</span><br><span class="line">                       != forwardBit) &#123;</span><br><span class="line">                   l.softInputMode = (l.softInputMode</span><br><span class="line">                           &amp; (~WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION))</span><br><span class="line">                           | forwardBit;</span><br><span class="line">                   <span class="keyword">if</span> (r.activity.mVisibleFromClient) &#123;</span><br><span class="line">                       ViewManager wm = a.getWindowManager();</span><br><span class="line">                       View decor = r.window.getDecorView();</span><br><span class="line">                       wm.updateViewLayout(decor, l);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               r.activity.mVisibleFromServer = <span class="keyword">true</span>;</span><br><span class="line">               mNumVisibleActivities++;</span><br><span class="line">               <span class="keyword">if</span> (r.activity.mVisibleFromClient) &#123;</span><br><span class="line">                   r.activity.makeVisible();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">// 标注 2结束</span></span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (!r.onlyLocalRequest) &#123;</span><br><span class="line">               r.nextIdle = mNewActivities;</span><br><span class="line">               mNewActivities = r;</span><br><span class="line">               <span class="keyword">if</span> (localLOGV) Slog.v(</span><br><span class="line">                   TAG, <span class="string">"Scheduling idle handler for "</span> + r);</span><br><span class="line">               Looper.myQueue().addIdleHandler(<span class="keyword">new</span> Idler());</span><br><span class="line">           &#125;</span><br><span class="line">           r.onlyLocalRequest = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Tell the activity manager we have resumed.</span></span><br><span class="line">           <span class="keyword">if</span> (reallyResume) &#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   ActivityManagerNative.getDefault().activityResumed(token);</span><br><span class="line">               &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">// If an exception was thrown when trying to resume, then</span></span><br><span class="line">           <span class="comment">// just end this activity.</span></span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               ActivityManagerNative.getDefault()</span><br><span class="line">                   .finishActivity(token, Activity.RESULT_CANCELED, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>代码有点长,但我们只需关注两个部分,我已经在代码上做了标注.先来看一下<code>标注1</code>的代码.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// If the window hasn't yet been added to the window manager,</span></span><br><span class="line">         <span class="comment">// and this guy didn't finish itself or start another activity,</span></span><br><span class="line">         <span class="comment">// then go ahead and add the window.</span></span><br><span class="line">         <span class="keyword">boolean</span> willBeVisible = !a.mStartedActivity;<span class="comment">// 标记1开始</span></span><br><span class="line">         <span class="keyword">if</span> (!willBeVisible) &#123;</span><br><span class="line">             <span class="keyword">try</span> &#123;</span><br><span class="line">                 willBeVisible = ActivityManagerNative.getDefault().willActivityBeVisible(</span><br><span class="line">                         a.getActivityToken());</span><br><span class="line">             &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// 关键部分</span></span><br><span class="line">         <span class="keyword">if</span> (r.window == <span class="keyword">null</span> &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;</span><br><span class="line">         	<span class="comment">// 1</span></span><br><span class="line">             r.window = r.activity.getWindow(); </span><br><span class="line">             <span class="comment">// 2</span></span><br><span class="line">             View decor = r.window.getDecorView(); </span><br><span class="line">             decor.setVisibility(View.INVISIBLE);</span><br><span class="line">             <span class="comment">// 3</span></span><br><span class="line">             ViewManager wm = a.getWindowManager();</span><br><span class="line">             WindowManager.LayoutParams l = r.window.getAttributes();</span><br><span class="line">             <span class="comment">// 4</span></span><br><span class="line">             a.mDecor = decor;</span><br><span class="line">             l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION;</span><br><span class="line">             l.softInputMode |= forwardBit;</span><br><span class="line">             <span class="keyword">if</span> (a.mVisibleFromClient) &#123;</span><br><span class="line">                 a.mWindowAdded = <span class="keyword">true</span>;</span><br><span class="line">                 <span class="comment">// 5</span></span><br><span class="line">                 wm.addView(decor, l);</span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// If the window has already been added, but during resume</span></span><br><span class="line">         <span class="comment">// we started another activity, then don't yet make the</span></span><br><span class="line">         <span class="comment">// window visible.</span></span><br><span class="line">         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!willBeVisible) &#123;</span><br><span class="line">             <span class="keyword">if</span> (localLOGV) Slog.v(</span><br><span class="line">                 TAG, <span class="string">"Launch "</span> + r + <span class="string">" mStartedActivity set"</span>);</span><br><span class="line">             r.hideForNow = <span class="keyword">true</span>;</span><br><span class="line">         &#125; <span class="comment">// 标注 1结束</span></span><br></pre></td></tr></table></figure></p>
<p>其中这里的<code>r,a</code>分别是函数中的局部变量,<code>r</code>是一个<code>ActivityClientRecord</code>类型的对象,通过<code>performResumeActivity()</code>函数获取,代表的是Activity执行完<code>onResume()</code>之后的含有Activity相关状态信息的对象.而<code>a</code>则是<code>r</code>所对应的Activity.清楚了这两个变量的意义后,我们可以对代码进行分析了.首先获取了<code>willBeVisible</code>的值,它代表的是activity是否将要显示在手机屏幕上.接着来到被标注为<code>关键部分</code>的<code>if</code>语句块内的代码.代码主要做了下面的事情(我已在上面的代码中标出了对应的代码句).  </p>
<ol>
<li>将<code>r.window</code>赋值为activity的<code>mWindow</code>(即<code>PhoneWindow</code>对象)</li>
<li>获取<code>r.window</code>的DecorView对象(即我们<code>PhoneWindow</code>的<code>mDecor</code>对象),并将其设置为不可见</li>
<li>获取activity的<code>mWindowManager</code>对象和<code>r.window</code>的布局参数</li>
<li><strong>将第2点获取的<code>DecorView</code>对象赋值给<code>a.mDecor</code>((将<code>PhoneWindow</code>的<code>mDecor</code>)与(<code>Activity</code>的<code>mDecor</code>)关联起来)</strong></li>
<li>通过第3点获取的<code>mWindowManager</code>对象根据布局参数将<code>mDecor</code>添加到window上.</li>
</ol>
<p>通过上面的代码,我们成功的将<code>mDecor</code>添加到window当中,但我们的<code>mDecor</code>还是不可见的,所以下面将要分析的<code>标注2</code>的代码就是让<code>mDecor</code>变得可见.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The window is now visible if it has been added, we are not</span></span><br><span class="line">         <span class="comment">// simply finishing, and we are not starting another activity.</span></span><br><span class="line">         <span class="comment">// 标注 2开始</span></span><br><span class="line">         <span class="keyword">if</span> (!r.activity.mFinished &amp;&amp; willBeVisible</span><br><span class="line">                 &amp;&amp; r.activity.mDecor != <span class="keyword">null</span> &amp;&amp; !r.hideForNow) &#123;</span><br><span class="line">             <span class="keyword">if</span> (r.newConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                 r.tmpConfig.setTo(r.newConfig);</span><br><span class="line">                 <span class="keyword">if</span> (r.overrideConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                     r.tmpConfig.updateFrom(r.overrideConfig);</span><br><span class="line">                 &#125;</span><br><span class="line">                 <span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG, <span class="string">"Resuming activity "</span></span><br><span class="line">                         + r.activityInfo.name + <span class="string">" with newConfig "</span> + r.tmpConfig);</span><br><span class="line">                 performConfigurationChanged(r.activity, r.tmpConfig);</span><br><span class="line">                 freeTextLayoutCachesIfNeeded(r.activity.mCurrentConfig.diff(r.tmpConfig));</span><br><span class="line">                 r.newConfig = <span class="keyword">null</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">"Resuming "</span> + r + <span class="string">" with isForward="</span></span><br><span class="line">                     + isForward);</span><br><span class="line">             WindowManager.LayoutParams l = r.window.getAttributes();</span><br><span class="line">             <span class="keyword">if</span> ((l.softInputMode</span><br><span class="line">                     &amp; WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION)</span><br><span class="line">                     != forwardBit) &#123;</span><br><span class="line">                 l.softInputMode = (l.softInputMode</span><br><span class="line">                         &amp; (~WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION))</span><br><span class="line">                         | forwardBit;</span><br><span class="line">                 <span class="keyword">if</span> (r.activity.mVisibleFromClient) &#123;</span><br><span class="line">                     ViewManager wm = a.getWindowManager();</span><br><span class="line">                     View decor = r.window.getDecorView();</span><br><span class="line">                     wm.updateViewLayout(decor, l);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">             r.activity.mVisibleFromServer = <span class="keyword">true</span>;</span><br><span class="line">             mNumVisibleActivities++;</span><br><span class="line">             <span class="keyword">if</span> (r.activity.mVisibleFromClient) &#123;</span><br><span class="line">                 r.activity.makeVisible();</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// 标注 2结束</span></span><br></pre></td></tr></table></figure></p>
<p>其实上面的代码我们需要关心的就只有一句,就是<code>r.activity.makeVisible();</code>这句.这句话调用了我们之前在<code>Activity</code>源码中找到的<code>makeVisible()</code>函数,将<code>mDecor</code>设置为可见.到此,我们知道了<code>mDecor</code>是怎样添加到window上的了.</p>
<h3 id="是终点也是起点"><a href="#是终点也是起点" class="headerlink" title="是终点也是起点"></a>是终点也是起点</h3><p>作为一个热爱技术的年轻人(码农),怎么可能会在这里就停止前进的脚步呢?所以在上面<code>makeVisible()</code>函数中的一句代码<code>wm.addView(mDecor, getWindow().getAttributes());</code>展开了新的起点 - - - 继续探索View的工作原理(希望能有新的发现).<br>我毫不犹豫的点进了<code>addView()</code>的源码,却发现这是<code>ViewManager</code>接口的方法.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/** Interface to let you add and remove child views to an Activity. To get an instance</span><br><span class="line">  * of this class, call &#123;<span class="doctag">@link</span> android.content.Context#getSystemService(java.lang.String) Context.getSystemService()&#125;.</span><br><span class="line">  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ViewManager</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Assign the passed LayoutParams to the passed View and add the view to the window.</span><br><span class="line">     * &lt;p&gt;Throws &#123;<span class="doctag">@link</span> android.view.WindowManager.BadTokenException&#125; for certain programming</span><br><span class="line">     * errors, such as adding a second view to a window without removing the first view.</span><br><span class="line">     * &lt;p&gt;Throws &#123;<span class="doctag">@link</span> android.view.WindowManager.InvalidDisplayException&#125; if the window is on a</span><br><span class="line">     * secondary &#123;<span class="doctag">@link</span> Display&#125; and the specified display can't be found</span><br><span class="line">     * (see &#123;<span class="doctag">@link</span> android.app.Presentation&#125;).</span><br><span class="line">     * <span class="doctag">@param</span> view The view to be added to this window.</span><br><span class="line">     * <span class="doctag">@param</span> params The LayoutParams to assign to view.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, ViewGroup.LayoutParams params)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateViewLayout</span><span class="params">(View view, ViewGroup.LayoutParams params)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeView</span><span class="params">(View view)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个接口是用于将<code>View</code>添加到<code>Activity</code>或从<code>Activity</code>移除<code>View</code>的.既然这样,那就去找它的实现类.从下面<code>Activity</code>的部分源码中不难发现<code>addView()</code>是通过<code>Activity</code>的<code>mWindowManger</code>调用的,而<code>Activity</code>的<code>mWindowManager</code>是通过<code>Window</code>获取的.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> WindowManager mWindowManager;</span><br><span class="line">   <span class="keyword">private</span> Window mWindow;</span><br><span class="line"><span class="comment">/** Retrieve the window manager for showing custom windows. */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> WindowManager <span class="title">getWindowManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> mWindowManager;</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context, ActivityThread aThread,</span><br><span class="line">           Instrumentation instr, IBinder token, <span class="keyword">int</span> ident,</span><br><span class="line">           Application application, Intent intent, ActivityInfo info,</span><br><span class="line">           CharSequence title, Activity parent, String id,</span><br><span class="line">           NonConfigurationInstances lastNonConfigurationInstances,</span><br><span class="line">           Configuration config, String referrer, IVoiceInteractor voiceInteractor)</span> </span>&#123;</span><br><span class="line">           ........</span><br><span class="line">           mWindowManager = mWindow.getWindowManager();</span><br><span class="line">           ........</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>由此我们可以转到<code>Window</code>的源码中寻找<code>mWindowManager</code>的下落.在<code>Window</code>的源码中,很容易就能找到我们的<code>mWindowManager</code>的相关代码了.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> WindowManager mWindowManager;</span><br><span class="line"><span class="comment">/**</span><br><span class="line">    * Set the window manager for use by this Window to, for example,</span><br><span class="line">    * display panels.  This is &lt;em&gt;not&lt;/em&gt; used for displaying the</span><br><span class="line">    * Window itself -- that must be done by the client.</span><br><span class="line">    *</span><br><span class="line">    * <span class="doctag">@param</span> wm The window manager for adding new windows.</span><br><span class="line">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWindowManager</span><span class="params">(WindowManager wm, IBinder appToken, String appName,</span><br><span class="line">           <span class="keyword">boolean</span> hardwareAccelerated)</span> </span>&#123;</span><br><span class="line">       mAppToken = appToken;</span><br><span class="line">       mAppName = appName;</span><br><span class="line">       mHardwareAccelerated = hardwareAccelerated</span><br><span class="line">               || SystemProperties.getBoolean(PROPERTY_HARDWARE_UI, <span class="keyword">false</span>);</span><br><span class="line">       <span class="keyword">if</span> (wm == <span class="keyword">null</span>) &#123;</span><br><span class="line">           wm = (WindowManager)mContext.getSystemService(Context.WINDOW_SERVICE);</span><br><span class="line">       &#125;</span><br><span class="line">       mWindowManager = ((WindowManagerImpl)wm).createLocalWindowManager(<span class="keyword">this</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的<code>mWindowManager</code>是通过<code>WindowManagerImpl</code>的<code>createLocalWindowManager()</code>函数进行赋值的.所以继续转到<code>WindowManagerImpl</code>的代码中.在<code>WindowManagerImpl</code>的代码中终于发现了想要的<code>addView()</code>的代码了.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(@NonNull View view, @NonNull ViewGroup.LayoutParams params)</span> </span>&#123;</span><br><span class="line">       applyDefaultToken(params);</span><br><span class="line">       mGlobal.addView(view, params, mDisplay, mParentWindow);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> WindowManagerGlobal mGlobal = WindowManagerGlobal.getInstance();</span><br></pre></td></tr></table></figure></p>
<p>可以看出<code>WindowManagerImpl</code>中的<code>addView()</code>调用的是<code>mGlobal(WindowManagerGlobal)</code>的<code>addView()</code>.看来我们的代码还没结束…自己挖的坑,再深也要走下去,继续跳转到<code>WindowManagerGlobal</code>的<code>addView()</code>代码里.看来这次是到达了真正的目的地了.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, ViewGroup.LayoutParams params,</span><br><span class="line">           Display display, Window parentWindow)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (view == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"view must not be null"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (display == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"display must not be null"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (!(params <span class="keyword">instanceof</span> WindowManager.LayoutParams)) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Params must be WindowManager.LayoutParams"</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">final</span> WindowManager.LayoutParams wparams = (WindowManager.LayoutParams) params;</span><br><span class="line">       <span class="keyword">if</span> (parentWindow != <span class="keyword">null</span>) &#123;</span><br><span class="line">           parentWindow.adjustLayoutParamsForSubWindow(wparams);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">// If there's no parent, then hardware acceleration for this view is</span></span><br><span class="line">           <span class="comment">// set from the application's hardware acceleration setting.</span></span><br><span class="line">           <span class="keyword">final</span> Context context = view.getContext();</span><br><span class="line">           <span class="keyword">if</span> (context != <span class="keyword">null</span></span><br><span class="line">                   &amp;&amp; (context.getApplicationInfo().flags</span><br><span class="line">                           &amp; ApplicationInfo.FLAG_HARDWARE_ACCELERATED) != <span class="number">0</span>) &#123;</span><br><span class="line">               wparams.flags |= WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       ViewRootImpl root;</span><br><span class="line">       View panelParentView = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">           <span class="comment">// Start watching for system property changes.</span></span><br><span class="line">           <span class="keyword">if</span> (mSystemPropertyUpdater == <span class="keyword">null</span>) &#123;</span><br><span class="line">               mSystemPropertyUpdater = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                   <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                       <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">                           <span class="keyword">for</span> (<span class="keyword">int</span> i = mRoots.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">                               mRoots.get(i).loadSystemProperties();</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;;</span><br><span class="line">               SystemProperties.addChangeCallback(mSystemPropertyUpdater);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">int</span> index = findViewLocked(view, <span class="keyword">false</span>);</span><br><span class="line">           <span class="keyword">if</span> (index &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">               <span class="keyword">if</span> (mDyingViews.contains(view)) &#123;</span><br><span class="line">                   <span class="comment">// Don't wait for MSG_DIE to make it's way through root's queue.</span></span><br><span class="line">                   mRoots.get(index).doDie();</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"View "</span> + view</span><br><span class="line">                           + <span class="string">" has already been added to the window manager."</span>);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">// The previous removeView() had not completed executing. Now it has.</span></span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// If this is a panel window, then find the window it is being</span></span><br><span class="line">           <span class="comment">// attached to for future reference.</span></span><br><span class="line">           <span class="keyword">if</span> (wparams.type &gt;= WindowManager.LayoutParams.FIRST_SUB_WINDOW &amp;&amp;</span><br><span class="line">                   wparams.type &lt;= WindowManager.LayoutParams.LAST_SUB_WINDOW) &#123;</span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">int</span> count = mViews.size();</span><br><span class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (mRoots.get(i).mWindow.asBinder() == wparams.token) &#123;</span><br><span class="line">                       panelParentView = mViews.get(i);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">		<span class="comment">// 标注</span></span><br><span class="line">           root = <span class="keyword">new</span> ViewRootImpl(view.getContext(), display);</span><br><span class="line"></span><br><span class="line">           view.setLayoutParams(wparams);</span><br><span class="line"></span><br><span class="line">           mViews.add(view);</span><br><span class="line">           mRoots.add(root);</span><br><span class="line">           mParams.add(wparams);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// do this last because it fires off messages to start doing things</span></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           root.setView(view, wparams, panelParentView);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">           <span class="comment">// BadTokenException or InvalidDisplayException, clean up.</span></span><br><span class="line">           <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">int</span> index = findViewLocked(view, <span class="keyword">false</span>);</span><br><span class="line">               <span class="keyword">if</span> (index &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                   removeViewLocked(index, <span class="keyword">true</span>);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">throw</span> e;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>由于代码有点长,按照惯例,我们只关注有用的部分.在上面代码中,我发现了一个<code>setView()</code>的函数,相信这个函数就是我们想要的.那就看下这部分的代码(从我在注释中标注的代码开始).代码中创建了一个名为<code>root</code>的<code>ViewRootImpl</code>对象并调用了<code>root.setView()</code>.既然调用了函数,那按照我的风格怎么都要进去看看,万一有意外收获呢.<br>下面就是<code>ViewRootImpl</code>的<code>setView()</code>的代码(提示:下面代码可以跳过):<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">    * We have one child</span><br><span class="line">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setView</span><span class="params">(View view, WindowManager.LayoutParams attrs, View panelParentView)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span> (mView == <span class="keyword">null</span>) &#123;</span><br><span class="line">               mView = view;</span><br><span class="line"></span><br><span class="line">               mAttachInfo.mDisplayState = mDisplay.getState();</span><br><span class="line">               mDisplayManager.registerDisplayListener(mDisplayListener, mHandler);</span><br><span class="line"></span><br><span class="line">               mViewLayoutDirectionInitial = mView.getRawLayoutDirection();</span><br><span class="line">               mFallbackEventHandler.setView(view);</span><br><span class="line">               mWindowAttributes.copyFrom(attrs);</span><br><span class="line">               <span class="keyword">if</span> (mWindowAttributes.packageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">                   mWindowAttributes.packageName = mBasePackageName;</span><br><span class="line">               &#125;</span><br><span class="line">               attrs = mWindowAttributes;</span><br><span class="line">               <span class="comment">// Keep track of the actual window flags supplied by the client.</span></span><br><span class="line">               mClientWindowLayoutFlags = attrs.flags;</span><br><span class="line"></span><br><span class="line">               setAccessibilityFocus(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (view <span class="keyword">instanceof</span> RootViewSurfaceTaker) &#123;</span><br><span class="line">                   mSurfaceHolderCallback =</span><br><span class="line">                           ((RootViewSurfaceTaker)view).willYouTakeTheSurface();</span><br><span class="line">                   <span class="keyword">if</span> (mSurfaceHolderCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                       mSurfaceHolder = <span class="keyword">new</span> TakenSurfaceHolder();</span><br><span class="line">                       mSurfaceHolder.setFormat(PixelFormat.UNKNOWN);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="comment">// Compute surface insets required to draw at specified Z value.</span></span><br><span class="line">               <span class="comment">// <span class="doctag">TODO:</span> Use real shadow insets for a constant max Z.</span></span><br><span class="line">               <span class="keyword">if</span> (!attrs.hasManualSurfaceInsets) &#123;</span><br><span class="line">                   <span class="keyword">final</span> <span class="keyword">int</span> surfaceInset = (<span class="keyword">int</span>) Math.ceil(view.getZ() * <span class="number">2</span>);</span><br><span class="line">                   attrs.surfaceInsets.set(surfaceInset, surfaceInset, surfaceInset, surfaceInset);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               CompatibilityInfo compatibilityInfo = mDisplayAdjustments.getCompatibilityInfo();</span><br><span class="line">               mTranslator = compatibilityInfo.getTranslator();</span><br><span class="line"></span><br><span class="line">               <span class="comment">// If the application owns the surface, don't enable hardware acceleration</span></span><br><span class="line">               <span class="keyword">if</span> (mSurfaceHolder == <span class="keyword">null</span>) &#123;</span><br><span class="line">                   enableHardwareAcceleration(attrs);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">boolean</span> restore = <span class="keyword">false</span>;</span><br><span class="line">               <span class="keyword">if</span> (mTranslator != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   mSurface.setCompatibilityTranslator(mTranslator);</span><br><span class="line">                   restore = <span class="keyword">true</span>;</span><br><span class="line">                   attrs.backup();</span><br><span class="line">                   mTranslator.translateWindowLayout(attrs);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (DEBUG_LAYOUT) Log.d(TAG, <span class="string">"WindowLayout in setView:"</span> + attrs);</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (!compatibilityInfo.supportsScreen()) &#123;</span><br><span class="line">                   attrs.privateFlags |= WindowManager.LayoutParams.PRIVATE_FLAG_COMPATIBLE_WINDOW;</span><br><span class="line">                   mLastInCompatMode = <span class="keyword">true</span>;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               mSoftInputMode = attrs.softInputMode;</span><br><span class="line">               mWindowAttributesChanged = <span class="keyword">true</span>;</span><br><span class="line">               mWindowAttributesChangesFlag = WindowManager.LayoutParams.EVERYTHING_CHANGED;</span><br><span class="line">               mAttachInfo.mRootView = view;</span><br><span class="line">               mAttachInfo.mScalingRequired = mTranslator != <span class="keyword">null</span>;</span><br><span class="line">               mAttachInfo.mApplicationScale =</span><br><span class="line">                       mTranslator == <span class="keyword">null</span> ? <span class="number">1.0f</span> : mTranslator.applicationScale;</span><br><span class="line">               <span class="keyword">if</span> (panelParentView != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   mAttachInfo.mPanelParentWindowToken</span><br><span class="line">                           = panelParentView.getApplicationWindowToken();</span><br><span class="line">               &#125;</span><br><span class="line">               mAdded = <span class="keyword">true</span>;</span><br><span class="line">               <span class="keyword">int</span> res; <span class="comment">/* = WindowManagerImpl.ADD_OKAY; */</span></span><br><span class="line"></span><br><span class="line">               <span class="comment">// Schedule the first layout -before- adding to the window</span></span><br><span class="line">               <span class="comment">// manager, to make sure we do the relayout before receiving</span></span><br><span class="line">               <span class="comment">// any other events from the system.</span></span><br><span class="line">               </span><br><span class="line">               <span class="comment">// 标注 , 我就是通过光明的入口</span></span><br><span class="line">               requestLayout();</span><br><span class="line">               </span><br><span class="line">               <span class="keyword">if</span> ((mWindowAttributes.inputFeatures</span><br><span class="line">                       &amp; WindowManager.LayoutParams.INPUT_FEATURE_NO_INPUT_CHANNEL) == <span class="number">0</span>) &#123;</span><br><span class="line">                   mInputChannel = <span class="keyword">new</span> InputChannel();</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   mOrigWindowType = mWindowAttributes.type;</span><br><span class="line">                   mAttachInfo.mRecomputeGlobalAttributes = <span class="keyword">true</span>;</span><br><span class="line">                   collectViewAttributes();</span><br><span class="line">                   res = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes,</span><br><span class="line">                           getHostVisibility(), mDisplay.getDisplayId(),</span><br><span class="line">                           mAttachInfo.mContentInsets, mAttachInfo.mStableInsets,</span><br><span class="line">                           mAttachInfo.mOutsets, mInputChannel);</span><br><span class="line">               &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                   mAdded = <span class="keyword">false</span>;</span><br><span class="line">                   mView = <span class="keyword">null</span>;</span><br><span class="line">                   mAttachInfo.mRootView = <span class="keyword">null</span>;</span><br><span class="line">                   mInputChannel = <span class="keyword">null</span>;</span><br><span class="line">                   mFallbackEventHandler.setView(<span class="keyword">null</span>);</span><br><span class="line">                   unscheduleTraversals();</span><br><span class="line">                   setAccessibilityFocus(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Adding window failed"</span>, e);</span><br><span class="line">               &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                   <span class="keyword">if</span> (restore) &#123;</span><br><span class="line">                       attrs.restore();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (mTranslator != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   mTranslator.translateRectInScreenToAppWindow(mAttachInfo.mContentInsets);</span><br><span class="line">               &#125;</span><br><span class="line">               mPendingOverscanInsets.set(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">               mPendingContentInsets.set(mAttachInfo.mContentInsets);</span><br><span class="line">               mPendingStableInsets.set(mAttachInfo.mStableInsets);</span><br><span class="line">               mPendingVisibleInsets.set(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">               <span class="keyword">if</span> (DEBUG_LAYOUT) Log.v(TAG, <span class="string">"Added window "</span> + mWindow);</span><br><span class="line">               <span class="keyword">if</span> (res &lt; WindowManagerGlobal.ADD_OKAY) &#123;</span><br><span class="line">                   mAttachInfo.mRootView = <span class="keyword">null</span>;</span><br><span class="line">                   mAdded = <span class="keyword">false</span>;</span><br><span class="line">                   mFallbackEventHandler.setView(<span class="keyword">null</span>);</span><br><span class="line">                   unscheduleTraversals();</span><br><span class="line">                   setAccessibilityFocus(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                   <span class="keyword">switch</span> (res) &#123;</span><br><span class="line">                       <span class="keyword">case</span> WindowManagerGlobal.ADD_BAD_APP_TOKEN:</span><br><span class="line">                       <span class="keyword">case</span> WindowManagerGlobal.ADD_BAD_SUBWINDOW_TOKEN:</span><br><span class="line">                           <span class="keyword">throw</span> <span class="keyword">new</span> WindowManager.BadTokenException(</span><br><span class="line">                                   <span class="string">"Unable to add window -- token "</span> + attrs.token</span><br><span class="line">                                   + <span class="string">" is not valid; is your activity running?"</span>);</span><br><span class="line">                       <span class="keyword">case</span> WindowManagerGlobal.ADD_NOT_APP_TOKEN:</span><br><span class="line">                           <span class="keyword">throw</span> <span class="keyword">new</span> WindowManager.BadTokenException(</span><br><span class="line">                                   <span class="string">"Unable to add window -- token "</span> + attrs.token</span><br><span class="line">                                   + <span class="string">" is not for an application"</span>);</span><br><span class="line">                       <span class="keyword">case</span> WindowManagerGlobal.ADD_APP_EXITING:</span><br><span class="line">                           <span class="keyword">throw</span> <span class="keyword">new</span> WindowManager.BadTokenException(</span><br><span class="line">                                   <span class="string">"Unable to add window -- app for token "</span> + attrs.token</span><br><span class="line">                                   + <span class="string">" is exiting"</span>);</span><br><span class="line">                       <span class="keyword">case</span> WindowManagerGlobal.ADD_DUPLICATE_ADD:</span><br><span class="line">                           <span class="keyword">throw</span> <span class="keyword">new</span> WindowManager.BadTokenException(</span><br><span class="line">                                   <span class="string">"Unable to add window -- window "</span> + mWindow</span><br><span class="line">                                   + <span class="string">" has already been added"</span>);</span><br><span class="line">                       <span class="keyword">case</span> WindowManagerGlobal.ADD_STARTING_NOT_NEEDED:</span><br><span class="line">                           <span class="comment">// Silently ignore -- we would have just removed it</span></span><br><span class="line">                           <span class="comment">// right away, anyway.</span></span><br><span class="line">                           <span class="keyword">return</span>;</span><br><span class="line">                       <span class="keyword">case</span> WindowManagerGlobal.ADD_MULTIPLE_SINGLETON:</span><br><span class="line">                           <span class="keyword">throw</span> <span class="keyword">new</span> WindowManager.BadTokenException(</span><br><span class="line">                                   <span class="string">"Unable to add window "</span> + mWindow +</span><br><span class="line">                                   <span class="string">" -- another window of this type already exists"</span>);</span><br><span class="line">                       <span class="keyword">case</span> WindowManagerGlobal.ADD_PERMISSION_DENIED:</span><br><span class="line">                           <span class="keyword">throw</span> <span class="keyword">new</span> WindowManager.BadTokenException(</span><br><span class="line">                                   <span class="string">"Unable to add window "</span> + mWindow +</span><br><span class="line">                                   <span class="string">" -- permission denied for this window type"</span>);</span><br><span class="line">                       <span class="keyword">case</span> WindowManagerGlobal.ADD_INVALID_DISPLAY:</span><br><span class="line">                           <span class="keyword">throw</span> <span class="keyword">new</span> WindowManager.InvalidDisplayException(</span><br><span class="line">                                   <span class="string">"Unable to add window "</span> + mWindow +</span><br><span class="line">                                   <span class="string">" -- the specified display can not be found"</span>);</span><br><span class="line">                       <span class="keyword">case</span> WindowManagerGlobal.ADD_INVALID_TYPE:</span><br><span class="line">                           <span class="keyword">throw</span> <span class="keyword">new</span> WindowManager.InvalidDisplayException(</span><br><span class="line">                                   <span class="string">"Unable to add window "</span> + mWindow</span><br><span class="line">                                   + <span class="string">" -- the specified window type is not valid"</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                           <span class="string">"Unable to add window -- unknown error code "</span> + res);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (view <span class="keyword">instanceof</span> RootViewSurfaceTaker) &#123;</span><br><span class="line">                   mInputQueueCallback =</span><br><span class="line">                       ((RootViewSurfaceTaker)view).willYouTakeTheInputQueue();</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (mInputChannel != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (mInputQueueCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                       mInputQueue = <span class="keyword">new</span> InputQueue();</span><br><span class="line">                       mInputQueueCallback.onInputQueueCreated(mInputQueue);</span><br><span class="line">                   &#125;</span><br><span class="line">                   mInputEventReceiver = <span class="keyword">new</span> WindowInputEventReceiver(mInputChannel,</span><br><span class="line">                           Looper.myLooper());</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               view.assignParent(<span class="keyword">this</span>);</span><br><span class="line">               mAddedTouchMode = (res &amp; WindowManagerGlobal.ADD_FLAG_IN_TOUCH_MODE) != <span class="number">0</span>;</span><br><span class="line">               mAppVisible = (res &amp; WindowManagerGlobal.ADD_FLAG_APP_VISIBLE) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (mAccessibilityManager.isEnabled()) &#123;</span><br><span class="line">                   mAccessibilityInteractionConnectionManager.ensureConnection();</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (view.getImportantForAccessibility() == View.IMPORTANT_FOR_ACCESSIBILITY_AUTO) &#123;</span><br><span class="line">                   view.setImportantForAccessibility(View.IMPORTANT_FOR_ACCESSIBILITY_YES);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="comment">// Set up the input pipeline.</span></span><br><span class="line">               CharSequence counterSuffix = attrs.getTitle();</span><br><span class="line">               mSyntheticInputStage = <span class="keyword">new</span> SyntheticInputStage();</span><br><span class="line">               InputStage viewPostImeStage = <span class="keyword">new</span> ViewPostImeInputStage(mSyntheticInputStage);</span><br><span class="line">               InputStage nativePostImeStage = <span class="keyword">new</span> NativePostImeInputStage(viewPostImeStage,</span><br><span class="line">                       <span class="string">"aq:native-post-ime:"</span> + counterSuffix);</span><br><span class="line">               InputStage earlyPostImeStage = <span class="keyword">new</span> EarlyPostImeInputStage(nativePostImeStage);</span><br><span class="line">               InputStage imeStage = <span class="keyword">new</span> ImeInputStage(earlyPostImeStage,</span><br><span class="line">                       <span class="string">"aq:ime:"</span> + counterSuffix);</span><br><span class="line">               InputStage viewPreImeStage = <span class="keyword">new</span> ViewPreImeInputStage(imeStage);</span><br><span class="line">               InputStage nativePreImeStage = <span class="keyword">new</span> NativePreImeInputStage(viewPreImeStage,</span><br><span class="line">                       <span class="string">"aq:native-pre-ime:"</span> + counterSuffix);</span><br><span class="line"></span><br><span class="line">               mFirstInputStage = nativePreImeStage;</span><br><span class="line">               mFirstPostImeInputStage = earlyPostImeStage;</span><br><span class="line">               mPendingInputEventQueueLengthCounterName = <span class="string">"aq:pending:"</span> + counterSuffix;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>Shit!(尼玛)</strong>,怎么感觉越陷越深.如果有这种感觉的同学那就对了,正所谓不如虎穴,焉得虎子.坚持一下,光明就在前方.<br>在上面的一大串代码中,我发现了一句非常熟悉的代码<code>requestLayout();</code>(我已在上面的代码进行了标注),这不是View在需要重新布局的时候调用的函数吗,怎么会在这里出现.正所谓<code>Everything for a reason</code>,我毫不犹豫的点了进去.(各位同学肯定在想:还有完没完…我只能说:相信我就跟我走下去,你会有所发现的).<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestLayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (!mHandlingLayoutInLayoutRequest) &#123;</span><br><span class="line">           checkThread();</span><br><span class="line">           mLayoutRequested = <span class="keyword">true</span>;</span><br><span class="line">           scheduleTraversals();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>这是停不下来的感觉啊,接着轮到<code>scheduleTraversals()</code>,我把其中相关的都贴出来了.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TraversalRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            doTraversal();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">final</span> TraversalRunnable mTraversalRunnable = <span class="keyword">new</span> TraversalRunnable();</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">scheduleTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!mTraversalScheduled) &#123;</span><br><span class="line">            mTraversalScheduled = <span class="keyword">true</span>;</span><br><span class="line">            mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();</span><br><span class="line">            mChoreographer.postCallback(</span><br><span class="line">                    Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (!mUnbufferedInputDispatch) &#123;</span><br><span class="line">                scheduleConsumeBatchedInput();</span><br><span class="line">            &#125;</span><br><span class="line">            notifyRendererOfFramePending();</span><br><span class="line">            pokeDrawLockIfNeeded();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的<code>scheduleTraversals()</code>设置了回调<code>mTraversalRunnable</code>,而在回调里调用了<code>doTraversal()</code>.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doTraversal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (mTraversalScheduled) &#123;</span><br><span class="line">           mTraversalScheduled = <span class="keyword">false</span>;</span><br><span class="line">           mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (mProfile) &#123;</span><br><span class="line">               Debug.startMethodTracing(<span class="string">"ViewAncestor"</span>);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           performTraversals();</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (mProfile) &#123;</span><br><span class="line">               Debug.stopMethodTracing();</span><br><span class="line">               mProfile = <span class="keyword">false</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>接着来到最终的一个函数了,就是上面在<code>doTraversal()</code>里调用的<code>performTraversals()</code>.这个函数的代码可不是一般的长,所以我也不再挑战大家的极限了,我就直接给出<code>performTraversals()</code>函数里的3个关键的语句.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	.......</span><br><span class="line">    <span class="comment">// 用来决定view的宽高</span></span><br><span class="line">    performMeasure();</span><br><span class="line">    .......</span><br><span class="line">    <span class="comment">// view顶点坐标</span></span><br><span class="line">    performLayout();</span><br><span class="line">    .......</span><br><span class="line">    <span class="comment">// view绘制</span></span><br><span class="line">    performDraw();</span><br><span class="line">    .......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>是不是有点熟悉的感觉,这就是View的3大流程,<strong><em><code>measure,layout,draw</code></em></strong>,原来View的3大流程是在这里执行的.到这里我们已经简略地走完了View的工作流程了.</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>像上次一样,最后还是用张图总结本篇的内容,这样会使我们头脑清晰一点.<br><img src="http://o7x6n1hmo.bkt.clouddn.com/image/schdule.png" alt="流程"><br>上图的箭头表示了函数之间的调用,其中的<code>CallBack:mTraversalRunnable</code>一处代表的是设置回调函数.<br>经过本篇的学习我们发现了View的绘制是由<code>performTraversals()</code>函数发起的.下一篇开始我们就来研究研究绘制View的第一个流程<code>Mesure</code>.</p>

      
    </div>
    <footer class="article-footer">
	  
	  <a data-url="http://kevinhqf.github.io/2016/09/20/ViewDetails_02/" data-id="citec0q7x000w1x867vfryxve" data_title="Android学习笔记---深入理解View#02" data_summary="上篇文章中我们了解到了setContentView()..." class="article-share-link">Share</a>
      
        <a href="http://kevinhqf.github.io/2016/09/20/ViewDetails_02/#disqus_thread" class="article-comment-link">Comments</a>
      

      
	  
      
	  
<span>
Updated:<time datetime="2016-09-20T02:53:43.625Z" itemprop="dateModified">2016-09-20</time>
</span>


    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/09/22/ViewDetails_03/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Android学习笔记---深入理解View#03
        
      </div>
    </a>
  
  
    <a href="/2016/09/17/ViewDetails_01/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Android学习笔记---深入理解View#01</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>



</section>
        
          
  <div id="toc" class="toc-aside">
  <h2 class="toc-title">Contents</h2>
    
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#寻找我们的-mDecor"><span class="toc-number">1.</span> <span class="toc-text">寻找我们的 mDecor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#是终点也是起点"><span class="toc-number">2.</span> <span class="toc-text">是终点也是起点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-number">3.</span> <span class="toc-text">总结</span></a></li></ol>
    
  </div>

<aside id="sidebar">

  
    
<div class="widget-wrap">
  <h3 class="widget-title">ABOUT ME</h3>
  <ul class="widget about-me">
    
    <li><img class="author" title="About me" src="/images/avatar.jpg" /></li>
    
    
    <li>Hi,I'm Kevin.</li>
    
  </ul>
</div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/android/">Android</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">Java</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/markdown/">Markdown</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>


  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">13</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/09/22/ViewDetails_03/">Android学习笔记---深入理解View#03</a>
          </li>
        
          <li>
            <a href="/2016/09/20/ViewDetails_02/">Android学习笔记---深入理解View#02</a>
          </li>
        
          <li>
            <a href="/2016/09/17/ViewDetails_01/">Android学习笔记---深入理解View#01</a>
          </li>
        
          <li>
            <a href="/2016/09/14/CustomView-custom_drawing/">Android学习笔记---重新学习自定义View#02</a>
          </li>
        
          <li>
            <a href="/2016/09/12/CustomView-create_view/">Android学习笔记---重新学习自定义View#01</a>
          </li>
        
      </ul>
    </div>
  </div>


  
    

  

</aside>

        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Kevin HO<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and Theme by <a href="https://github.com/howiefh/hexo-theme-landscape-f" target="_blank" title="Landscape-F">Landscape-F</a>
    
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'kevinhqf';
  
  var disqus_url = 'http://kevinhqf.github.io/2016/09/20/ViewDetails_02/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//go.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>






<script src="/js/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<div class="bottom-btn">

	<a class="icon-gotop" href="javascript:void(0)" title="返回顶部"></a>
	<script src="/js/gotop.js"></script>
	<!--
	<script src="/js/gotop.js"></script>
	-->


	<a class="icon-toc-toggle" href="javascript:void(0)" title="文章目录"></a>
	<!--
	<script src="/js/toc_aside_toggle.js"></script>
	-->

</div>
<script src="/js/toc_aside_toggle.js"></script>


<script src="/js/script.js"></script>







  </div>
</body>
</html>
